---
layout    : post
title     : Raft ä¸ºä»€ä¹ˆæ˜¯æ›´æ˜“ç†è§£çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•
date      : 2016-03-01
author    : mindwind
categories: blog
tags      : Raft åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•
image     : /assets/article_images/2016-03-01.jpg
elapse    :
---


ä¸€è‡´æ€§é—®é¢˜å¯ä»¥ç®—æ˜¯åˆ†å¸ƒå¼é¢†åŸŸçš„ä¸€ä¸ªåœ£æ®¿çº§é—®é¢˜äº†ï¼Œå…³äºå®ƒçš„ç ”ç©¶å¯ä»¥å›æº¯åˆ°å‡ åå¹´å‰ã€‚


## æ‹œå åº­å°†å†›é—®é¢˜
Leslie Lamport åœ¨ä¸‰åå¤šå¹´å‰å‘è¡¨çš„è®ºæ–‡ã€Šæ‹œå åº­å°†å†›é—®é¢˜ã€‹ï¼ˆå‚è€ƒ[1]ï¼‰ã€‚

æ‹œå åº­ä½äºå¦‚ä»Šçš„åœŸè€³å…¶çš„ä¼Šæ–¯å¦å¸ƒå°”ï¼Œæ˜¯ä¸œç½—é©¬å¸å›½çš„é¦–éƒ½ã€‚ç”±äºå½“æ—¶æ‹œå åº­ç½—é©¬å¸å›½å›½åœŸè¾½é˜”ï¼Œä¸ºäº†é˜²å¾¡ç›®çš„ï¼Œå› æ­¤æ¯ä¸ªå†›é˜Ÿéƒ½åˆ†éš”å¾ˆè¿œï¼Œå°†å†›ä¸å°†å†›ä¹‹é—´åªèƒ½é ä¿¡å·®ä¼ æ¶ˆæ¯ã€‚åœ¨æˆ˜äº‰çš„æ—¶å€™ï¼Œæ‹œå åº­å†›é˜Ÿå†…æ‰€æœ‰å°†å†›å¿…éœ€è¾¾æˆ **ä¸€è‡´çš„å…±è¯†**ï¼Œå†³å®šæ˜¯å¦æœ‰èµ¢çš„æœºä¼šæ‰å»æ”»æ‰“æ•Œäººçš„é˜µè¥ã€‚ä½†æ˜¯ï¼Œåœ¨å†›é˜Ÿå†…æœ‰å¯èƒ½å­˜æœ‰å›å¾’å’Œæ•Œå†›çš„é—´è°ï¼Œå·¦å³å°†å†›ä»¬çš„å†³å®šåˆæ‰°ä¹±æ•´ä½“å†›é˜Ÿçš„ç§©åºï¼Œåœ¨è¿›è¡Œå…±è¯†æ—¶ï¼Œç»“æœå¹¶ä¸ä»£è¡¨å¤§å¤šæ•°äººçš„æ„è§ã€‚è¿™æ—¶å€™ï¼Œåœ¨å·²çŸ¥æœ‰æˆå‘˜ä¸å¯é çš„æƒ…å†µä¸‹ï¼Œå…¶ä½™å¿ è¯šçš„å°†å†›åœ¨ä¸å—å›å¾’æˆ–é—´è°çš„å½±å“ä¸‹å¦‚ä½•è¾¾æˆä¸€è‡´çš„åè®®ï¼Œæ‹œå åº­é—®é¢˜å°±æ­¤å½¢æˆã€‚æ‹œå åº­å‡è®¾æ˜¯å¯¹ç°å®ä¸–ç•Œçš„æ¨¡å‹åŒ–ï¼Œç”±äºç¡¬ä»¶é”™è¯¯ã€ç½‘ç»œæ‹¥å¡æˆ–æ–­å¼€ä»¥åŠé­åˆ°æ¶æ„æ”»å‡»ï¼Œè®¡ç®—æœºå’Œç½‘ç»œå¯èƒ½å‡ºç°ä¸å¯é¢„æ–™çš„è¡Œä¸ºã€‚

Lamport ä¸€ç›´ç ”ç©¶è¿™ç±»é—®é¢˜ï¼Œå‘è¡¨äº†ä¸€ç³»åˆ—è®ºæ–‡ã€‚ä½†ç»¼åˆæ€»ç»“ä¸€ä¸‹å°±æ˜¯å›ç­”ä¸‹é¢ä¸‰ä¸ªé—®é¢˜ï¼š

  1. ç±»ä¼¼æ‹œå åº­å°†å†›è¿™æ ·çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜æ˜¯å¦æœ‰è§£ï¼Ÿ
  2. å¦‚æœæœ‰è§£çš„è¯éœ€è¦æ»¡è¶³ä»€ä¹ˆæ ·çš„æ¡ä»¶ï¼Ÿ
  3. åœ¨ç‰¹å®šå‰ææ¡ä»¶çš„åŸºç¡€ä¸Šï¼Œæå‡ºä¸€ç§è§£æ³•ã€‚

å‰ä¸¤ä¸ªé—®é¢˜ Lamport åœ¨è®ºæ–‡ã€Šæ‹œå åº­å°†å†›é—®é¢˜ã€‹å·²ç»å›ç­”ï¼Œè€Œç¬¬ä¸‰ä¸ªé—®é¢˜åœ¨åæ¥çš„è®ºæ–‡ ã€ŠThe Part-Time Parliamentã€‹ä¸­æå‡ºäº†ä¸€ç§ç®—æ³•å¹¶å‘½åä¸º Paxosã€‚è¿™ç¯‡è®ºæ–‡ä½¿ç”¨äº†å¤§é‡çš„æ•°å­¦è¯æ˜ï¼Œè€Œæˆ‘åŸºæœ¬å°±çœ‹ä¸æ‡‚äº†ï¼ˆæ•°å­¦ç¬¦å·éƒ½è®¤ä¸å…¨ğŸ˜¢ï¼‰ï¼Œè€ƒè™‘åˆ°å¤§å®¶ç†è§£èµ·æ¥éƒ½æ¯”è¾ƒå›°éš¾ï¼Œåæ¥ Lamport åˆå†™äº†å¦å¤–ä¸€ç¯‡è®ºæ–‡ ã€ŠPaxos Made Simpleã€‹å®Œå…¨æ”¾å¼ƒäº†æ‰€æœ‰æ•°å­¦ç¬¦å·çš„è¯æ˜ï¼Œä½¿ç”¨çº¯è‹±æ–‡çš„é€»è¾‘æ¨å¯¼ã€‚æˆ‘å‹‰å¼ºé€å­—çœ‹äº†ä¸€éï¼Œç„¶åæ„Ÿè§‰è‹¥æœ‰æ‰€æ‚Ÿï¼Œä½†ä½ é—®æˆ‘ææ‡‚äº†å—ï¼Œæˆ‘çš„æ ‡å‡†åº”è¯¥è¿˜æ˜¯æ²¡æ‡‚ã€‚å¯¹æˆ‘æ¥è¯´ç†è§£ä¸€ä¸ªç®—æ³•æœ‰ä¸ªæ˜ç¡®çš„æ ‡å‡†ï¼Œå°±æ˜¯çœŸçš„æ‡‚äº†ä¼šåœ¨å¤´è„‘é‡Œèƒ½å°†ç®—æ³•æ˜ å°„ä¸ºä»£ç ï¼Œè€Œçœ‹å®Œåé¢ä¸€ç¯‡è®ºæ–‡ä»…ä»…æ˜¯è‹¥æœ‰æ‰€æ‚Ÿè¿˜è¾¾ä¸åˆ°èƒ½æ˜ å°„ä¸ºä»£ç çš„æ¸…æ™°åº¦ã€‚

è™½ç„¶ Lamport è®¤ä¸º Paxos å¾ˆ simpleï¼Œä½†ä¹Ÿè®¸åªæ˜¯é’ˆå¯¹ä»–çš„å¤´è„‘è€Œè¨€ã€‚äº‹å®æ˜¯å¤§å®¶ç†è§£èµ·æ¥éƒ½è¿˜æ˜¯å¾ˆå›°éš¾ï¼Œæ‰€ä»¥ Raft å°±æ˜¯å»ºç«‹åœ¨å¸Œæœ›å¾—åˆ°ä¸€ä¸ªæ›´æ˜“äºç†è§£çš„ Paxos ç®—æ³•çš„æ›¿ä»£å“ã€‚æŠŠå¯ç†è§£æ€§ä½œä¸ºç®—æ³•çš„ä¸»è¦ç›®æ ‡ä¹‹ä¸€ï¼Œä»è®ºæ–‡é¢˜ç›®å°±å¯çœ‹å‡ºæ¥ã€ŠIn Search of an Understandable Consensus Algorithmã€‹ã€‚

åœ¨è¿›å…¥æ­£é¢˜å‰ï¼Œæˆ‘æƒ³èµ·ä¸€ä¸ªæ—§æ•…äº‹å¯ä»¥å¾ˆç›´è§‚çš„æ„Ÿå—å¯¹ä¸€ä¸ªé—®é¢˜ä¸åŒçš„æ€ç»´è§†è§’åœ¨å¯ç†è§£æ€§ä¸Šçš„å·®å¼‚ã€‚


## ä¸åŒè§†è§’çš„å¯ç†è§£æ€§
ä¾ç¨€è®°å¾—å¤§çº¦åœ¨äºŒåå¹´å‰ï¼Œæˆ‘è¿˜åœ¨è¯»åˆä¸­æ—¶åœ¨ä¸€æœ¬å¯èƒ½å¤§æ¦‚å«ã€Šæ•°å­¦ä¸­çš„å‘æ•£æ€ç»´ã€‹ï¼ˆä¸èƒ½å¾ˆæ¸…æ™°è®°å¾—ä¹¦åäº†ï¼‰çš„ä¹¦ä¸­çœ‹åˆ°è¿™ä¹ˆä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ã€‚

  > ç”²ä¹™ä¸¤äººè½®æµåœ¨ä¸€å¼ åœ†æ¡Œä¸Šå¹³æ”¾é»‘ç™½å›´æ£‹å­ï¼Œæ¯æ¬¡æ”¾ä¸€å­ï¼Œæ£‹å­ä¸è®¸é‡å ï¼Œè°å…ˆæ²¡æœ‰åœ°æ–¹æ”¾å°±è¾“ã€‚
  > è¯·é—®æ€æ ·æ”¾æ‰èƒ½èµ¢ï¼Ÿ

è¿™ä¸ªé—®é¢˜æœ‰ä¸¤å±‚æ„æ€ï¼Œç¬¬ä¸€ï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ”¾æ³•ä¿è¯å¿…èµ¢ï¼Ÿç¬¬äºŒï¼Œå¦‚æœæœ‰æ€ä¹ˆè¯æ˜ï¼Ÿè¿™é‡Œå…ˆåœé¡¿ä¸‹ï¼Œæ€è€ƒåç§’é’Ÿã€‚

![](/assets/article_images/2016-03-01-1.png)

ä¸Šé¢çš„å›¾å›ç­”äº†è¿™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å…ˆè¡Œè€…å¿…èƒœï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸‰ç§ä¸åŒçš„æ€ç»´æ–¹å¼ã€‚

  1. å‡å¦‚æ¡Œå­åªæœ‰ä¸€ä¸ªå›´æ£‹å­é‚£ä¹ˆå¤§ã€‚
  2. å‡å¦‚æ¡Œå­æ— é™å¤§ï¼Œå…ˆè¡Œè€…å…ˆå ä½åœ†å¿ƒï¼Œç”±äºåœ†æ˜¯å¯¹ç§°å›¾å½¢ï¼Œæ‰€ä»¥åªè¦å¯¹æ‰‹è¿˜èƒ½æ‰¾åˆ°ä½ç½®æ”¾ï¼Œä½ æ€»èƒ½åœ¨å¯¹ç§°çš„å¦ä¸€é¢æ‰¾åˆ°ä½ç½®æ”¾ã€‚
  3. ä¸€ä¸ªåœ†ä¸­å¯ç”»å•æ•°ä¸ªç›´å¾„ç›¸ç­‰ä¸”äº’åˆ‡çš„å°åœ†ã€‚

ä¸‰ç§ä¸åŒçš„æ€ç»´æ–¹å¼åœ¨å¯ç†è§£æ€§éš¾åº¦ä¸Šé€æ¸åŠ æ·±ã€‚ç¬¬ä¸€ç§æ˜¯æç®€åŒ–æ€ç»´ï¼Œä½†æ•°å­¦ä¸Šæ˜¯ä¸ä¸¥è°¨çš„ã€‚ç¬¬äºŒç§æ˜¯æé™æ€ç»´ï¼Œå’Œç¬¬ä¸€ç§ç»“åˆèµ·æ¥å°±æ˜¯æ•°å­¦å½’çº³æ³•äº†ï¼Œåœ¨æ•°å­¦ä¸Šæ˜¯ä¸¥è°¨çš„ã€‚ç¬¬ä¸‰ç§æ˜¯å½¢è±¡æ€ç»´ï¼Œä½¿ç”¨äº†å‡ ä½•å­¦æ¦‚å¿µï¼Œä½†å¯¹äºæ²¡æœ‰å‡ ä½•å­¦åŸºç¡€çŸ¥è¯†çš„äººå°±å¾ˆéš¾ç†è§£äº†ã€‚


## Raft åè®®çš„æ˜“ç†è§£æ€§æè¿°
è™½ç„¶ Raft çš„è®ºæ–‡æ¯” Paxos ç®€å•ç‰ˆè®ºæ–‡è¿˜å®¹æ˜“è¯»äº†ï¼Œä½†è®ºæ–‡ä¾ç„¶å‘æ•£çš„æ¯”è¾ƒå¤šï¼Œç›¸å¯¹å†—é•¿ã€‚è¯»å®Œåæ©å·æ²‰æ€è§‰å¾—è¿˜æ˜¯æ•´ç†ä¸€ä¸‹æ‰ä¼šæ›´ç‰¢é ï¼Œå˜æˆçœŸæ­£å±äºè‡ªå·±çš„ã€‚è¿™é‡Œæˆ‘å°±å€ŸåŠ©å‰é¢é»‘ç™½æ£‹è½å­é‡Œç¬¬ä¸€ç§æç®€æ€ç»´æ¥æè¿°å’Œæ¦‚å¿µéªŒè¯ä¸‹ Raft åè®®çš„å·¥ä½œæ–¹å¼ã€‚

åœ¨ä¸€ä¸ªç”± Raft åè®®ç»„ç»‡çš„é›†ç¾¤ä¸­æœ‰ä¸‰ç±»è§’è‰²ï¼š

  1. Leaderï¼ˆé¢†è¢–ï¼‰
  2. Followerï¼ˆç¾¤ä¼—ï¼‰
  3. Candidateï¼ˆå€™é€‰äººï¼‰

å°±åƒä¸€ä¸ªæ°‘ä¸»ç¤¾ä¼šï¼Œé¢†è¢–ç”±æ°‘ä¼—æŠ•ç¥¨é€‰å‡ºã€‚åˆšå¼€å§‹æ²¡æœ‰é¢†è¢–ï¼Œæ‰€æœ‰é›†ç¾¤ä¸­çš„å‚ä¸è€…éƒ½æ˜¯ç¾¤ä¼—ï¼Œé‚£ä¹ˆé¦–å…ˆå¼€å¯ä¸€è½®å¤§é€‰ï¼Œåœ¨å¤§é€‰æœŸé—´æ‰€æœ‰ç¾¤ä¼—éƒ½èƒ½å‚ä¸ç«é€‰ï¼Œè¿™æ—¶æ‰€æœ‰ç¾¤ä¼—çš„è§’è‰²å°±å˜æˆäº†å€™é€‰äººï¼Œæ°‘ä¸»æŠ•ç¥¨é€‰å‡ºé¢†è¢–åå°±å¼€å§‹äº†è¿™å±Šé¢†è¢–çš„ä»»æœŸï¼Œç„¶åé€‰ä¸¾ç»“æŸï¼Œæ‰€æœ‰é™¤é¢†è¢–çš„å€™é€‰äººåˆå˜å›ç¾¤ä¼—è§’è‰²æœä»é¢†è¢–é¢†å¯¼ã€‚è¿™é‡Œæåˆ°ä¸€ä¸ªæ¦‚å¿µã€Œä»»æœŸã€ï¼Œç”¨æœ¯è¯­ Term è¡¨è¾¾ã€‚å…³äº Raft åè®®çš„æ ¸å¿ƒæ¦‚å¿µå’Œæœ¯è¯­å°±è¿™ä¹ˆå¤šè€Œä¸”å’Œç°å®æ°‘ä¸»åˆ¶åº¦éå¸¸åŒ¹é…ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“ç†è§£ã€‚ä¸‰ç±»è§’è‰²çš„å˜è¿å›¾å¦‚ä¸‹ï¼Œç»“åˆåé¢çš„é€‰ä¸¾è¿‡ç¨‹æ¥çœ‹å¾ˆå®¹æ˜“ç†è§£ã€‚

![](/assets/article_images/2016-03-01-2.png)


### Leader é€‰ä¸¾è¿‡ç¨‹
åœ¨æç®€çš„æ€ç»´ä¸‹ï¼Œä¸€ä¸ªæœ€å°çš„ Raft æ°‘ä¸»é›†ç¾¤éœ€è¦ä¸‰ä¸ªå‚ä¸è€…ï¼ˆå¦‚ä¸‹å›¾ï¼šAã€Bã€Cï¼‰ï¼Œè¿™æ ·æ‰å¯èƒ½æŠ•å‡ºå¤šæ•°ç¥¨ã€‚åˆå§‹çŠ¶æ€ ABC éƒ½æ˜¯ Followerï¼Œç„¶åå‘èµ·é€‰ä¸¾è¿™æ—¶æœ‰ä¸‰ç§å¯èƒ½æƒ…å½¢å‘ç”Ÿã€‚ä¸‹å›¾ä¸­å‰äºŒç§éƒ½èƒ½é€‰å‡º Leaderï¼Œç¬¬ä¸‰ç§åˆ™è¡¨æ˜æœ¬è½®æŠ•ç¥¨æ— æ•ˆï¼ˆSplit Votesï¼‰ï¼Œæ¯æ–¹éƒ½æŠ•ç»™äº†è‡ªå·±ï¼Œç»“æœæ²¡æœ‰ä»»ä½•ä¸€æ–¹è·å¾—å¤šæ•°ç¥¨ã€‚ä¹‹åæ¯ä¸ªå‚ä¸æ–¹éšæœºä¼‘æ¯ä¸€é˜µï¼ˆElection Timeoutï¼‰é‡æ–°å‘èµ·æŠ•ç¥¨ç›´åˆ°ä¸€æ–¹è·å¾—å¤šæ•°ç¥¨ã€‚è¿™é‡Œçš„å…³é”®å°±æ˜¯éšæœº timeoutï¼Œæœ€å…ˆä» timeout ä¸­æ¢å¤å‘èµ·æŠ•ç¥¨çš„ä¸€æ–¹å‘è¿˜åœ¨ timeout ä¸­çš„å¦å¤–ä¸¤æ–¹è¯·æ±‚æŠ•ç¥¨ï¼Œè¿™æ—¶å®ƒä»¬å°±åªèƒ½æŠ•ç»™å¯¹æ–¹äº†ï¼Œå¾ˆå¿«è¾¾æˆä¸€è‡´ã€‚

![](/assets/article_images/2016-03-01-3.png)

é€‰å‡º Leader åï¼ŒLeader é€šè¿‡å®šæœŸå‘æ‰€æœ‰ Follower å‘é€å¿ƒè·³ä¿¡æ¯ç»´æŒå…¶ç»Ÿæ²»ã€‚è‹¥ Follower ä¸€æ®µæ—¶é—´æœªæ”¶åˆ° Leader çš„å¿ƒè·³åˆ™è®¤ä¸º Leader å¯èƒ½å·²ç»æŒ‚äº†å†æ¬¡å‘èµ·é€‰ä¸»è¿‡ç¨‹ã€‚


### Leader èŠ‚ç‚¹å¯¹ä¸€è‡´æ€§çš„å½±å“
Raft åè®®å¼ºä¾èµ– Leader èŠ‚ç‚¹çš„å¯ç”¨æ€§æ¥ç¡®ä¿é›†ç¾¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚æ•°æ®çš„æµå‘åªèƒ½ä» Leader èŠ‚ç‚¹å‘ Follower èŠ‚ç‚¹è½¬ç§»ã€‚å½“ Client å‘é›†ç¾¤ Leader èŠ‚ç‚¹æäº¤æ•°æ®åï¼ŒLeader èŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ•°æ®å¤„äºæœªæäº¤çŠ¶æ€ï¼ˆUncommittedï¼‰ï¼Œæ¥ç€ Leader èŠ‚ç‚¹ä¼šå¹¶å‘å‘æ‰€æœ‰ Follower èŠ‚ç‚¹å¤åˆ¶æ•°æ®å¹¶ç­‰å¾…æ¥æ”¶å“åº”ï¼Œç¡®ä¿è‡³å°‘é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°èŠ‚ç‚¹å·²æ¥æ”¶åˆ°æ•°æ®åå†å‘ Client ç¡®è®¤æ•°æ®å·²æ¥æ”¶ã€‚ä¸€æ—¦å‘ Client å‘å‡ºæ•°æ®æ¥æ”¶ Ack å“åº”åï¼Œè¡¨æ˜æ­¤æ—¶æ•°æ®çŠ¶æ€è¿›å…¥å·²æäº¤ï¼ˆCommittedï¼‰ï¼ŒLeader èŠ‚ç‚¹å†å‘ Follower èŠ‚ç‚¹å‘é€šçŸ¥å‘ŠçŸ¥è¯¥æ•°æ®çŠ¶æ€å·²æäº¤ã€‚

![](/assets/article_images/2016-03-01-4.png)

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»èŠ‚ç‚¹å¯èƒ½åœ¨ä»»æ„é˜¶æ®µæŒ‚æ‰ï¼Œçœ‹ä¸‹ Raft åè®®å¦‚ä½•é’ˆå¯¹ä¸åŒé˜¶æ®µä¿éšœæ•°æ®ä¸€è‡´æ€§çš„ã€‚

#### 1. æ•°æ®åˆ°è¾¾ Leader èŠ‚ç‚¹å‰
è¿™ä¸ªé˜¶æ®µ Leader æŒ‚æ‰ä¸å½±å“ä¸€è‡´æ€§ï¼Œä¸å¤šè¯´ã€‚

![](/assets/article_images/2016-03-01-5.png)

#### 2. æ•°æ®åˆ°è¾¾ Leader èŠ‚ç‚¹ï¼Œä½†æœªå¤åˆ¶åˆ° Follower èŠ‚ç‚¹
è¿™ä¸ªé˜¶æ®µ Leader æŒ‚æ‰ï¼Œæ•°æ®å±äºæœªæäº¤çŠ¶æ€ï¼ŒClient ä¸ä¼šæ”¶åˆ° Ack ä¼šè®¤ä¸ºè¶…æ—¶å¤±è´¥å¯å®‰å…¨å‘èµ·é‡è¯•ã€‚Follower èŠ‚ç‚¹ä¸Šæ²¡æœ‰è¯¥æ•°æ®ï¼Œé‡æ–°é€‰ä¸»å Client é‡è¯•é‡æ–°æäº¤å¯æˆåŠŸã€‚åŸæ¥çš„ Leader èŠ‚ç‚¹æ¢å¤åä½œä¸º Follower åŠ å…¥é›†ç¾¤é‡æ–°ä»å½“å‰ä»»æœŸçš„æ–° Leader å¤„åŒæ­¥æ•°æ®ï¼Œå¼ºåˆ¶ä¿æŒå’Œ Leader æ•°æ®ä¸€è‡´ã€‚

![](/assets/article_images/2016-03-01-6.png)

#### 3. æ•°æ®åˆ°è¾¾ Leader èŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ° Follower æ‰€æœ‰èŠ‚ç‚¹ï¼Œä½†è¿˜æœªå‘ Leader å“åº”æ¥æ”¶
è¿™ä¸ªé˜¶æ®µ Leader æŒ‚æ‰ï¼Œè™½ç„¶æ•°æ®åœ¨ Follower èŠ‚ç‚¹å¤„äºæœªæäº¤çŠ¶æ€ï¼ˆUncommittedï¼‰ä½†ä¿æŒä¸€è‡´ï¼Œé‡æ–°é€‰å‡º Leader åå¯å®Œæˆæ•°æ®æäº¤ï¼Œæ­¤æ—¶ Client ç”±äºä¸çŸ¥åˆ°åº•æäº¤æˆåŠŸæ²¡æœ‰ï¼Œå¯é‡è¯•æäº¤ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µ Raft è¦æ±‚ RPC è¯·æ±‚å®ç°å¹‚ç­‰æ€§ï¼Œä¹Ÿå°±æ˜¯è¦å®ç°å†…éƒ¨å»é‡æœºåˆ¶ã€‚

![](/assets/article_images/2016-03-01-7.png)

#### 4. æ•°æ®åˆ°è¾¾ Leader èŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ° Follower éƒ¨åˆ†èŠ‚ç‚¹ï¼Œä½†è¿˜æœªå‘ Leader å“åº”æ¥æ”¶
è¿™ä¸ªé˜¶æ®µ Leader æŒ‚æ‰ï¼Œæ•°æ®åœ¨ Follower èŠ‚ç‚¹å¤„äºæœªæäº¤çŠ¶æ€ï¼ˆUncommittedï¼‰ä¸”ä¸ä¸€è‡´ï¼ŒRaft åè®®è¦æ±‚æŠ•ç¥¨åªèƒ½æŠ•ç»™æ‹¥æœ‰æœ€æ–°æ•°æ®çš„èŠ‚ç‚¹ã€‚æ‰€ä»¥æ‹¥æœ‰æœ€æ–°æ•°æ®çš„èŠ‚ç‚¹ä¼šè¢«é€‰ä¸º Leader å†å¼ºåˆ¶åŒæ­¥æ•°æ®åˆ° Followerï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±å¹¶æœ€ç»ˆä¸€è‡´ã€‚

![](/assets/article_images/2016-03-01-8.png)

#### 5. æ•°æ®åˆ°è¾¾ Leader èŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ° Follower æ‰€æœ‰æˆ–å¤šæ•°èŠ‚ç‚¹ï¼Œæ•°æ®åœ¨ Leader å¤„äºå·²æäº¤çŠ¶æ€ï¼Œä½†åœ¨ Follower å¤„äºæœªæäº¤çŠ¶æ€
è¿™ä¸ªé˜¶æ®µ Leader æŒ‚æ‰ï¼Œé‡æ–°é€‰å‡ºæ–° Leader åçš„å¤„ç†æµç¨‹å’Œé˜¶æ®µ 3 ä¸€æ ·ã€‚

![](/assets/article_images/2016-03-01-9.png)

#### 6. æ•°æ®åˆ°è¾¾ Leader èŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ° Follower æ‰€æœ‰æˆ–å¤šæ•°èŠ‚ç‚¹ï¼Œæ•°æ®åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½å¤„äºå·²æäº¤çŠ¶æ€ï¼Œä½†è¿˜æœªå“åº” Client
è¿™ä¸ªé˜¶æ®µ Leader æŒ‚æ‰ï¼ŒCluster å†…éƒ¨æ•°æ®å…¶å®å·²ç»æ˜¯ä¸€è‡´çš„ï¼ŒClient é‡å¤é‡è¯•åŸºäºå¹‚ç­‰ç­–ç•¥å¯¹ä¸€è‡´æ€§æ— å½±å“ã€‚

![](/assets/article_images/2016-03-01-10.png)

#### 7. ç½‘ç»œåˆ†åŒºå¯¼è‡´çš„è„‘è£‚æƒ…å†µï¼Œå‡ºç°åŒ Leader
ç½‘ç»œåˆ†åŒºå°†åŸå…ˆçš„ Leader èŠ‚ç‚¹å’Œ Follower èŠ‚ç‚¹åˆ†éš”å¼€ï¼ŒFollower æ”¶ä¸åˆ° Leader çš„å¿ƒè·³å°†å‘èµ·é€‰ä¸¾äº§ç”Ÿæ–°çš„ Leaderã€‚è¿™æ—¶å°±äº§ç”Ÿäº†åŒ Leaderï¼ŒåŸå…ˆçš„ Leader ç‹¬è‡ªåœ¨ä¸€ä¸ªåŒºï¼Œå‘å®ƒæäº¤æ•°æ®ä¸å¯èƒ½å¤åˆ¶åˆ°å¤šæ•°èŠ‚ç‚¹æ‰€ä»¥æ°¸è¿œæäº¤ä¸æˆåŠŸã€‚å‘æ–°çš„ Leader æäº¤æ•°æ®å¯ä»¥æäº¤æˆåŠŸï¼Œç½‘ç»œæ¢å¤åæ—§çš„ Leader å‘ç°é›†ç¾¤ä¸­æœ‰æ›´æ–°ä»»æœŸï¼ˆTermï¼‰çš„æ–° Leader åˆ™è‡ªåŠ¨é™çº§ä¸º Follower å¹¶ä»æ–° Leader å¤„åŒæ­¥æ•°æ®è¾¾æˆé›†ç¾¤æ•°æ®ä¸€è‡´ã€‚

![](/assets/article_images/2016-03-01-11.png)


ç»¼ä¸Šç©·ä¸¾åˆ†æäº†æœ€å°é›†ç¾¤ï¼ˆ3 èŠ‚ç‚¹ï¼‰é¢ä¸´çš„æ‰€æœ‰æƒ…å†µï¼Œå¯ä»¥çœ‹å‡º Raft åè®®éƒ½èƒ½å¾ˆå¥½çš„åº”å¯¹ä¸€è‡´æ€§é—®é¢˜ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“ç†è§£ã€‚


## æ€»ç»“
å°±å¼•ç”¨ Raft è®ºæ–‡æœ€åçš„ä¸€èŠ‚çš„ç»¼è¿°æ¥æ€»ç»“æœ¬æ–‡å§ã€‚

  > ç®—æ³•ä»¥æ­£ç¡®æ€§ã€é«˜æ•ˆæ€§ã€ç®€æ´æ€§ä½œä¸ºä¸»è¦è®¾è®¡ç›®æ ‡ã€‚
  > è™½ç„¶è¿™äº›éƒ½æ˜¯å¾ˆæœ‰ä»·å€¼çš„ç›®æ ‡ï¼Œä½†è¿™äº›ç›®æ ‡éƒ½ä¸ä¼šè¾¾æˆç›´åˆ°å¼€å‘è€…å†™å‡ºä¸€ä¸ªå¯ç”¨çš„å®ç°ã€‚
  > æ‰€ä»¥æˆ‘ä»¬ç›¸ä¿¡å¯ç†è§£æ€§åŒæ ·é‡è¦ã€‚

æ·±ä»¥ä¸ºç„¶ï¼Œæƒ³æƒ³ Paxos ç®—æ³•æ˜¯ Leslie Lamport åœ¨ 1990 å¹´å°±å…¬å¼€å‘è¡¨åœ¨äº†è‡ªå·±çš„ç½‘ç«™ä¸Šï¼Œæƒ³æƒ³æˆ‘ä»¬æ˜¯ä»€ä¹ˆæ—¶å€™æ‰å¬è¯´çš„ï¼Ÿä»€ä¹ˆæ—¶å€™æ‰æœ‰ä¸€ä¸ªå¯ç”¨çš„å®ç°ï¼Ÿè€Œ Raft ç®—æ³•æ˜¯ 2013 å¹´å‘è¡¨çš„ï¼Œå¤§å®¶åœ¨å‚è€ƒ[5]ä¸Šé¢å¯ä»¥çœ‹åˆ°æœ‰å¤šå°‘ä¸ªä¸åŒè¯­è¨€å¼€æºçš„å®ç°åº“äº†ï¼Œè¿™å°±æ˜¯å¯ç†è§£æ€§çš„é‡è¦æ€§ã€‚


## å‚è€ƒ
[1]. LESLIE LAMPORT, ROBERT SHOSTAK, MARSHALL PEASE. [The Byzantine General Problem](http://research.microsoft.com/en-us/um/people/lamport/pubs/byz.pdf). 1982  
[2]. Leslie Lamport. [The Part-Time Parliament](http://research.microsoft.com/en-us/um/people/lamport/pubs/lamport-paxos.pdf). 1998  
[3]. Leslie Lamport. [Paxos Made Simple](http://research.microsoft.com/en-us/um/people/lamport/pubs/paxos-simple.pdf). 2001  
[4]. Diego Ongaro and John Ousterhout. [Raft Paper](https://ramcloud.stanford.edu/raft.pdf). 2013  
[5]. Raft Website. [The Raft Consensus Algorithm](https://raft.github.io/#implementations)  
[6]. Raft Animate Demo. (http://thesecretlivesofdata.com/raft/)  


---

å†™ç‚¹æ–‡å­—ï¼Œç”»ç‚¹ç”»å„¿ï¼Œã€Œç¬æ¯ä¹‹é—´ã€ä¸€åˆ‡éƒ½å˜äº†ã€‚è§‰å¾—ä¸é”™ï¼Œå¯é•¿æŒ‰æˆ–æ‰«æäºŒç»´ç å…³æ³¨ã€‚
![](/assets/images/qrcode_wechat_avatar.jpg)
